# 不同 GC 和堆内存的总结



## 案例1 GCLogAnalysis.java

硬件配置为8C16G，代码中的运行时间设为2秒，多次测试后选取取相对稳定的结果

### -Xms1g -Xmx1g -XX:-UseAdaptiveSizePolicy

|            | GC 次数 | Full GC 次数 | Full GC 平均暂停时间 | 总暂停时间 | 平均暂停时间 | 最大暂停时间 | throughput |
| ---------- | ------- | ------------ | -------------------- | ---------- | ------------ | ------------ | ---------- |
| SerialGC   | 31      | 6            | 0.044s               | 0.74s      | 0.023s       | 0.045s       | 60.47%     |
| ParallelGC | 41      | 7            | 0.037s               | 0.69s      | 0.017s       | 0.038s       | 63.01%     |
| CMS        | 44      | 3            | 0.044s               | 0.71s      | 0.016s       | 0.046s       | 62.52%     |
| G1         | 121     | 0            |                      | 0.65s      | 0.005s       | 0.019s       | 66.66%     |

### -Xms2g -Xmx2g -XX:-UseAdaptiveSizePolicy

|            | GC 次数 | Full GC 次数 | 总暂停时间 | 平均暂停时间 | 最大暂停时间 | throughput |
| ---------- | ------- | ------------ | ---------- | ------------ | ------------ | ---------- |
| SerialGC   | 16      | 1            | 0.66s      | 0.041s       | 0.055s       | 63.22%     |
| ParallelGC | 20      | 1            | 0.52s      | 0.026s       | 0.049s       | 71.15%     |
| CMS        | 20      | 0            | 0.62s      | 0.031s       | 0.055s       | 65.22%     |
| G1         | 39      | 0            | 0.42s      | 0.011s       | 0.031s       | 78.57%     |



## 案例2 gateway

sb -u 'http://127.0.0.1:8088/api/hello' -c 40 -N 30 -W 1

|            | (1g) request | (1g) RPS |
| ---------- | ------------ | -------- |
| SerialGC   | 92401        | 2876.3   |
| ParallelGC | 93406        | 2906.1   |
| CMS        | 89032        | 2767.2   |
| G1         | 96054        | 2987.1   |



使用jstat命令查看堆内存情况

```
jstat -gc -t <pid> 1s 120
```

观察发现，在启动期间发生了多次GC，使用不同的垃圾回收器会有不同的回收次数。在压测期间，eden区已使用的大小（EU）会稳定在一个固定的值，因而不会再触发GC。故推测上面结果中RPS的差异主要是因为CPU资源的波动，和垃圾回收器的选择无关。



## 总结

- 提高堆内存可以有效减少GC次数，进而提升性能
- 生成对象的数量，1g时`并行GC>CMS>G1>串行GC`，2g时`并行GC>G1>CMS>串行GC`
- 在性能和暂停时间的平衡上，G1相对较好，且内存越大，G1的效果越好

